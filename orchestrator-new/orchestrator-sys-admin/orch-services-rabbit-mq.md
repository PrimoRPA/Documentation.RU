# Настройк работы сервисов Оркестратора с RabbitMQ через SSL

Данная статья содержит следующие подразделы:

1.	Заведение OpenSSL сертификатов для работы через SSL.
2.	Настройка RabbitMQ на Linux для работы через SSL.
3.	Настройка RabbitMQ на Windows для работы через SSL.
4.	Настройка сервисов оркестратора для работы с RabbitMQ через SSL.
5.	Полезные ссылки.

## Заведение OpenSSL сертификатов для работы через SSL

1. Устанавливаем OpenSSL либо с [официального сайта](https://www.openssl.org/), либо используем ту версию, что идет в составе одной из утилит (например, можно использовать ту, которая идет в составе git).
2. Для того, чтобы в скриптах каждый раз не использовать полный путь к файлу openssl.exe, рекомендуется добавить этот путь в настройки системной переменной Path (если же вы предпочитаете работать через PowerShell, а не через командную строку, и не желаете изменять системную переменную Path, то можно использовать сеансовые алиасы). 
3. Далее в данном руководстве предполагается, что полный путь прописан в системной переменной Path. 
4. Прописать путь в Path, если вы работаете в Windows,  можно таким образом:
Открываем указанное ниже диалоговое окно (и далее выбираем соответствующие вкладки / нажимаем указанные кнопки / выбираем указанные строки из списков): 
* В нерусифицированной версии Windows:  
`System Properties > Advanced > Environment Variables… > System variables > Path > Edit… > New > [Тут указываем полный путь к файлу openssl.exe]:`
* В русской версии Windows:  
`Свойства системы > Дополнительно > Переменные среды… > Системные переменные > Path > Изменить… > Создать > [Тут указываем полный путь к файлу openssl.exe]:`

![](1)

![](2)

![](3)

5. Далее создаем каталог, в котором будут размещаться как сами сертификаты, так и необходимые для их создания файлы и переходим в него.
6. RabbitMQ должен при запуске иметь доступ к корневому сертификату СА, сертификату сервера и приватному ключу сертификата сервера. Создадим эти файлы.
7. Первым делом создаем корневой ключ CA и затем создаем корневой сертификат CA.  
Для этого открываем командную строку и выполняем в ней такие 2 команды:
```
openssl genrsa -out RMQ-CA-Key.pem

openssl req -new -key RMQ-CA-Key.pem -x509 -days 10000 -out RMQ-CA-cert.pem
```
Заполняем необходимые поля для сертификата. Имена выбираем произвольно. На этом корневой сертификат CA создан.

8. Генерируем ключ для сервера:
```
openssl genrsa -out RMQ-server-key.pem 2048
```
9. Теперь создаем запрос на сертификат сервера. 
```
openssl req -new -key RMQ-server-key.pem -out RMQ-signingrequest.csr
```
При заполнении полей, в поле *Common Name* важно указать имя сервера: домен или IP адрес сервера (например домен: `db.example.com` или IP-адрес: `192.168.0.116`):
10. Генерируем самоподписанный x509-сертификат сервера используя запрос на сертификат сервера, сертификат СА и ключ сертификата СА:
```
openssl x509 -req -days 1000 -in RMQ-signingrequest.csr -CA RMQ-CA-cert.pem -CAkey RMQ-CA-Key.pem -CAcreateserial -out RMQ-server-cert.pem
```
11. Теперь таким же образом (как описано в трех предыдущих пунктах) создаем связку ключ-сертификат для клиента. Имена файлов соответственно меняем (например: `RMQ-client-key.pem`, `RMQ-client-signingrequest.csr`, `RMQ-client-cert.pem`):
```
openssl genrsa -out RMQ-client-key.pem 2048

openssl req -new -sha256 -key RMQ-client-key.pem -out RMQ-client-signingrequest.csr

openssl x509 -req -days 1000 -in RMQ-client-signingrequest.csr -CA RMQ-CA-cert.pem -CAkey RMQ-CA-Key.pem -CAcreateserial -out RMQ-client-cert.pem
```
При заполнении полей сертификата клиента, в поле *Common Name* указываем логин под которым будет выполняться подключение к RabbitMQ (по умолчанию для сервисов Оркестратора это имя: `admin` – далее во всех скриптах в этом руководстве подразумевается, что было задано именно такое имя для этого параметра).
12. Для работы с RabbitMQ клиентам требуется специальный тип сертификата PKCS12, создаем его такой командой:
```
openssl pkcs12 -export -out client-identity.p12 -inkey RMQ-client-key.pem -in RMQ-client-cert.pem
```
13. При этом запоминаем (записываем) парольную фразу, требуемую для данного типа сертификатов. Она нам пригодится в дальнейшем при конфигурировании работы сервисов Оркестратора.



